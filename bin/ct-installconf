#!/bin/sh
##
## ct-install.sh
## Login : <ctaf@localhost.localdomain>
## Started on  Tue Apr 11 13:55:03 2006 GESTES Cedric
## $Id$
##
## Copyright (C) 2006 GESTES Cedric
## This program is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with this program; if not, write to the Free Software
## Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
##

#catch a signal, else termcaps shit
_trap_kill ()
{
  echo killing
  exit 0
}
trap _trap_kill INT


pkg_description()
{
    local name=$1

    eval $name"_description"
    return $?
}

pkg_is_installed()
{
    local name=$1

    eval $name"_is_installed"
    return $?
}

pkg_install()
{
    local name=$1

    eval $name"_install"
    return $?
}

pkg_uninstall()
{
    local name=$1

    eval $name"_uninstall"
    return $?
}

pkg_alwaysinstall()
{
    local name=$1

    eval $name"_alwaysinstall"
    return $?
}

pkg_source()
{
  local name=$1

  . ~/.ctafconf/etc/"$name".grk
}

#0 installed
#1 already installed
#2 failed
grk_install()
{
    local name
    name=$1
    local ret
    . ~/.ctafconf/etc/"$name".grk

    if pkg_is_installed $name; then
        ret=1
    else
        if pkg_install $name; then
            ret=0
        else
            ret=2
        fi
    fi
    if ! pkg_alwaysinstall $name ; then
        ret=2
    fi
    return $ret
}

grk_ask_install()
{
    name=$1

    . ~/.ctafconf/etc/"$name".grk
    if ! pkg_is_installed $name; then
      if ssft_yesno "Do you want to install $name" "`pkg_description $name`"; then
        echo "Ask: $name"
      fi
    fi
}

grk_install_list()
{
    list=$@
    for i in $list; do
        grk_install $i
        ret=$?
        if [ x$ret = x0 ]; then
            echo "Package installed: $i"
        elif [ x$ret = x1 ]; then
            echo "Package already installed: $i"
        else
            echo "## Package installation failed: $i ##"
        fi
    done
}


grk_installed_list()
{
    ls -1 ~/.ctafconf/etc | grep ".grk$" | while read line; do
        name=`echo $line | sed -e s/.grk//`
        . ~/.ctafconf/etc/"$name".grk
        if pkg_is_installed $name >/dev/null; then
            echo "$name"
        fi
    done
}

#############################################################################
##START
#############################################################################
if ! [ -d ~/.ctafconf/ ] ; then
  echo "Can't find ~/.ctafconf directory"
  echo "Aborting, verify that you have untar the archive into your home directory"
  exit
fi

#install tools
. ~/.ctafconf/etc/shlib/grktools.sh

#shellscript frontend
. ~/.ctafconf/etc/shlib/ssft.sh

#create default directory
grk_dir ~/.ctafconf/perso
grk_dir ~/.ctafconf/perso/semantic
grk_dir ~/.ctafconf/perso/ssh
grk_dir ~/.ctafconf/perso/repos
grk_dir ~/.ctafconf/perso/wallpaper
grk_dir ~/.ctafconf/perso/bin
grk_dir ~/.ctafconf/perso/previous

#launch profile manager
. ~/.ctafconf/bin/ct-profile


if ! [ -f ~/.ctafconf/perso/user-profile ] ; then
  echo "Can't find ~/.ctafconf/perso/user-profile directory"
  echo "Aborting, execute ct-profile, or relauch install"
  exit
fi
. ~/.ctafconf/perso/user-profile


export SSFT_FRONTEND=$ctafconf_interface



SSFT_DEFAULT=ask
ssft_select_single "Select one installation method" "'All' install every package, 'Ask' ask your before each package, and 'Choice' let you select packages you want in a list" all ask choice
insmethod=$SSFT_RESULT

###ASK
if [ x$insmethod = xask ] ; then
    ls -1 ~/.ctafconf/etc | grep ".grk$" | while read line; do
        name=`echo $line | sed -e s/.grk//`
        grk_ask_install $name
    done
fi

###ALL
if [ x$insmethod = xall ] ; then
    ls -1 ~/.ctafconf/etc | grep ".grk$" | while read line; do
        name=`echo $line | sed -e s/.grk//`
        echo installing $name
        grk_install $name
    done
fi

###CHOICE
if [ x$insmethod = xchoice ] ; then
    SSFT_DEFAULT=`grk_installed_list`
    ssft_select_multiple "Install" "Select packages you want to install" `ls -1 ~/.ctafconf/etc | grep ".grk$" | sed -e s/.grk//`
    grk_install_list $SSFT_RESULT
fi
